---
title: "Get started with mimsy"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(knitr)
library(kableExtra)
library(mimsy)
```

## 1. Introduction  

mimsy is a package designed to calculate dissolved gas concentrations of oxygen, nitrogen, and argon from Membrane Inlet Mass Spectrometer (MIMS) signal data. For more information on the gas solubility equations used in this package, please see the References section. No R expertise is required to use mimsy, and this guide is designed for novice R users.  

If you find bugs in this software, or you would like to suggest new features, please let us know on the [mimsy GitHub page](https://github.com/michelleckelly/mimsy/issues).  

## 2. Installation  

mimsy is not yet released on CRAN, the official repository for R packages. To download mimsy from GitHub, use the devtools package:  

```{r install.packages, eval = FALSE}
# Install the devtools package
install.packages("devtools")

# Load devtools
library(devtools)

# Download mimsy from github using devtools
install_github("michelleckelly/mimsy", dependencies = "Depends")
```

Afterwards, you can load mimsy like any other package:

```{r library, eval = FALSE}
# Load mimsy
library(mimsy)
```

## 3. Running mimsy  

The general structure for running mimsy is:  

1. Format your CSV file
2. Load CSV file into R using `read.csv()`
3. Run the `mimsy()` function
4. Explore the results
5. Save the results to an Excel file using `mimsy.save()` or an RData file using `save()`

### 3.1. Format your CSV file  

You'll need to add some special columns to your data file before loading it into R. The easiest way to do this is to use a spreadsheet editor like Excel. We recommend saving a seperate copy of your raw data file for mimsy (add "_mimsy" to the file name) to prevent any accidents.  

![Figure 1. An example of a correctly formatted raw data file.](excel.png)  

**CSV file format:**  

* You can save as CSV within Excel from the *File > Save as* menu, choosing the *CSV (Comma delimited) (.csv)* file extension option.

**Columns:**  

* Type  
    + If the row contains data for a standard, enter "Standard". If the row contains data for a sample, enter "Sample".
    + The name of this column must be "Type" (check for correct capitalization)  
* Group  
    + Each block of standards and the samples run directly afterwards belong to a group. You'll enter "1" for the first block of standards and the first block of samples. You'll enter "2" for the second block of standards and the second block of samples, etc.  
    + The name of this column must be "Group" (check for correct capitalization)  
* CollectionTemp  
    + The temperature of samples or standards at the time of field collection, in degrees C
    + The name of this column must be "CollectionTemp" (check for correct capitalization)  
* RunDate  
    + The date (M/D/YYYY) that samples were run on the MIMS.  
    + The name of this column must be "RunDate" (check for correct capitalization)  

* Label or other sample identifier columns  
    +  mimsy will preserve all labelling columns in the final output, so you should add whatever labels or notes columns you like

* Index, Time, 28, 32, 40, 99, N2/Ar, O2/Ar columns  
    + This is the default output from the MIMS  

### 3.2. Load your CSV file into R using `read.csv()`  

```{r load.csv.silent, eval = FALSE}
# Load data into R
data <- read.csv(file = "data.csv", header = TRUE, stringsAsFactors = FALSE)

# Check out the structure
str(data, vec.len = 2)
```
```{r load.csv, eval = TRUE, echo=FALSE}
# Load data
data <- 
  read.csv(file = "C://Users/Michelle/Documents/MS_ResearchProjects/R_packages/mimsy/vignettes/data.csv", 
           header = TRUE, stringsAsFactors = FALSE)

# Check out the structure
str(data, vec.len = 2)
```

### 3.3. Run the `mimsy()` function  

```{r run, eval = TRUE}
# Run the function
results <- mimsy(data, baromet.press = 977.2, units = "hPa")
```
```{r run.silent, echo = FALSE, eval=FALSE}
results <- mimsy(data, baromet.press = 977.2, units = "hPa")
```

You must specify the barometric pressure (`baromet.press`) and it's units in the function argument. Units must be one of `"atm"`, `"hPa"`, `"psi"`, `"bar"`, or `"Torr"`. All other inputs, such as background corrections or standard salinity, are optional. Check out `?mimsy` for more information.  

### 3.4. Explore the results  

```{r }

```


### 3.5. Save the results  




### Then, inspect the output:  

`mimsy()` returns a list containing five data frames:  

1. `$results`
2. `$solubility.Concentrations`
3. `$calibration.Factors`
4. `$calibration.DriftCorrection`
5. `$results.full`  

**`$results`** displays a summarized output, containing just identification columns (such as the user's input of `Label` or `Project`) and calculated concentration values (ex. `N2_uMol` and `N2_mg` for the concentration of dissolved dinitrogen gas, in microMoles and milligrams, respectively). `$results` only contains sample results, but see `$results.full` below for results from both samples and standards.  

```{r mimsyResults.display, eval = FALSE}
# results from the sample data
data$results
```
```{r mimsyResults.silent, eval = FALSE}
# output kable of results
kable(data$results, digits = 20, 
      col.names = c("Label", "CollectionTemp", "Notes", "Type",
                    "Group", "N2_uMol", "O2_uMol", "Ar_uMol", 
                    "N2_mg", "O2_mg", "Ar_mg")) %>%
  kable_styling(bootstrap_options = "condensed", full_width = F) %>%
  scroll_box(height = "300px")

```  



**`$solubility.Concentrations`** displays the calculated concentrations [$\small\mu Mole\:kg^{-1}$] of oxygen, nitrogen, and argon gas in water at specific temperature, pressure, and salinity. Row names correspond to `std.temps`. See Garcia and Gordon (1992, Eqn. 8) for further information on oxygen saturation concentration calculations and the equations used herein. See Hamme and Emerson (2004, Table 4, and Eq. 1, 2) for the expansion of Garcia and Gordon's methods for use with calculating nitrogen and argon saturation concentrations.  

**`$calibration.Factors`** are computed by taking the solubility concentrations at standard temperature divided by the average MIMS signal reading of each `Group` at said temperature. These values will then be used internally to calculate the calibration curve, and are made available to the user for transparency.  

**`$calibration.DriftCorrection`** is a data frame containing the slopes and intercepts of the calibration curve for each dissolved gas (ex. `calslope_28` for the slope of the dinitrogen calibration curve), and the drift corrected slope and intercept values (ex. `DRIFT.calslope_28`) which take into account the machine drift due to time that occurs in-between standard readings. These drift values are computed by taking the slope between successive calibration (slope or intercept) values. These values are used internally, and are made available to the user for transparency.  

**`$results.full`** is a data frame that contains the entire output from `mimsy()`, including results from both standards and samples, the initial MIMS signal data and signal ratios, the calibration curve correction factors for each reading (ex. `INTERPOLATED.calfactor_28`), and the final concentration values.  

## Save the output data

Save the entire output to a compact RData file for further R analysis, or use `mimsy.save()` to export to a multi-tabbed Excel file for analysis outside R.

```{r mimsy.save, eval=FALSE}
# Save output to an RData file
save(x = data, file = "results.RData")

# Save output to an Excel workbook
mimsy.save(x = data, file = "results.xlsx")
```

**`x`** the processed data, returned by the `mimsy()` function  

**`file`** desired file name with appropriate extension. Saves to user's working directory, unless an alternative path is specified.  

See the help file at `?save` or `?mimsy.save` for more information.  

Alternatively, you can save individual pieces of the output (such as `data$results`) using the `write.csv()` function. However, we recommend saving the full output for the sake of both reproducability and your future self.  

## 4. Putting it all together

```{r fullScript, eval=FALSE}
# Install the devtools package
install.packages("devtools")
# Load devtools
library(devtools)
# Download mimsy from Github using devtools
install_github("michelleckelly/mimsy", dependencies = "Depends")

# Load mimsy
library(mimsy)

# Load data into R
data <- read.csv(file = "data.csv", header = TRUE, stringsAsFactors = FALSE)

# Run the mimsy function
results <- mimsy(data, baromet.press = 977.2, units = "hPa")

# Save the results
mimsy.save(x = data, file = "results.xlsx") # To Excel file
save(x = data, file = "results.RData") # To RData file

# Done!
```
